
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>WebRTC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="js/bootstrap/css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
      body {
        padding-top: 40px;
        padding-bottom: 40px;
      }

      video {
        width: 100%;
        height: 100%;
        float: left;
      }

      .sidebar-nav {
        padding: 9px 0;
      }

      @media (max-width: 980px) {
        /* Enable use of floated navbar text */
        .navbar-text.pull-right {
          float: none;
          padding-left: 5px;
          padding-right: 5px;
        }
      }
    </style>
  </head>

  <body>

  <div id="main">
    <div class="navbar navbar-inverse navbar-fixed-top"> 
      <div class="navbar-inner">
        <div class="container-fluid">
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li><a href="#" onclick="talkFunction(false)"><i class="icon-user icon-white"></i> People</a></li>
              <li><a href="#" onclick="talkFunction(true)"><i class="icon-facetime-video icon-white"></i> Talk</a></li>
            </ul>
            <form id="form" class="navbar-form pull-right">
              <input id="user" class="span2" type="text" placeholder="User name">
              <button id="submit" type="submit" class="btn">Sign in</button>
            </form>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>


    <div class="container-fluid"> 
      <div class="row-fluid">
        <div id="people">
          <div id="people_content">
            <div class="carousel slide span10" id="myPeopleCarousel">
              <div class="carousel-inner people-carousel"></div>
              <a data-slide="prev" href="#myPeopleCarousel" class="left carousel-control">&lsaquo;</a>
              <a data-slide="next" href="#myPeopleCarousel" class="right carousel-control">&rsaquo;</a>
            </div>
          </div>
          
          <div class="thumbnail span2">
            <video id="sourceSmallvid" autoplay></video>
          </div>

          <div id="room_content">
            <div class="carousel slide span10" id="myRoomCarousel">
              <div class="carousel-inner rooms-carousel"></div>
              <a data-slide="prev" href="#myRoomCarousel" class="left carousel-control">&lsaquo;</a>
              <a data-slide="next" href="#myRoomCarousel" class="right carousel-control">&rsaquo;</a>
            </div>
          </div>

          <div class="inner"></div><!--/inner-->
        </div><!--/people-->

        <div id="share" class="span12">
        </div><!--/share-->

        <div id="me" class="span12">
        </div><!--/me-->

      </div><!--/row-->
    </div><!--/.fluid-container-->
  </div><!--/.main-->

  <div id="acceptModal" class="modal hide fade">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      <h3>Accept the call?</h3>
    </div>
    <div class="modal-body">
      <p id="caller"></p>
    </div>
    <div class="modal-footer">
      <a id="accept" href="#" class="btn btn-primary">Accept</a>
      <a id="reject" href="#" class="btn">Reject</a>
    </div>
  </div>


    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="js/bootstrap/js/bootstrap.min.js"></script>
    <script src="js/adapter.js"></script>
    <script src="js/script.js"></script>
    <script src="js/signaling.js"></script>
  </body>

  <script>
    var socketAddress = 'ws://localhost:1337/';

    var RTCApp = {
      name: null,
      room: null,
      webRTC: null,
      commChannel: null,
      message: null
    };

    RTCApp.commChannel = signaling({webSocketAddress : socketAddress, id: RTCApp.name });

    RTCApp.commChannel.addPresenceCallback(presenceCallback);
    RTCApp.commChannel.addOfferCallback(accept);

  
    RTCApp.webRTC = webrtc({sourcevid : document.getElementById('sourceSmallvid'),
      stunServer : "stun.l.google.com:19302",
      commChannel : RTCApp.commChannel,
      onremote : remoteCallback
    });
    
    RTCApp.webRTC.startVideo();

    $(document).ready(function() {
      loadFromJSON("data/people.json", "ajax-modal", ".people-carousel");
      loadFromJSON("data/rooms.json", "ajax-room-modal", ".rooms-carousel");
      $('#people').fadeIn();
      $('[id^="myCarousel"]').carousel({interval: false});
    });

    $("#form").submit(function() {
      event.preventDefault();

      RTCApp.name = $("#user").val();    
      RTCApp.commChannel.sendPresence(RTCApp.name, 'on');

      $('#user').attr('readonly', true);
      $("#submit").hide();
    });

    var caller;
    $('#accept').bind('click', function() {
      RTCApp.commChannel.answer(caller, 'accept');
      $('#acceptModal').modal('hide');
    });

    $('#reject').bind('click', function() {
      RTCApp.commChannel.answer(caller, 'reject');
      $('#acceptModal').modal('hide');
    });

    var snd = new Audio("data/ringtone.wav"); 
    function accept(from){
      caller = from;
      snd.play();
      $('#caller').text('You are getting a call request from ' + from);
      $('#acceptModal').modal('show');
    }

    function talkFunction(flag){
      var callback = flag === true? "hide" : "show"; 
      $('#people_content')[callback]();
      $('#room_content')[callback]();
    }

    function remoteCallback(from, added, stream){
      var resource = 'resource_'+ from;
      if(added){
        if (window.webkitURL) {
          $('.inner').append('<video class="span4" id=' + resource + ' src=' +  
              window.webkitURL.createObjectURL(event.stream) + ' autoplay></video>');
        } else {
          $('.inner').append('<video class="span4" id=' + resource + ' src=' +  
              event.stream + ' autoplay></video>');
        }
      } else {
        $('#'+resource).attr('src',"");
        $('#'+resource).remove();
      }
    }

    function presenceCallback(who, status){
      $(".ajax-modal").each(function(){
        var user_id = $(this).attr('user-id'); 
        if(user_id !== undefined && user_id === who){
          if(status === 'on'){
            $(this).find('img').attr('src', 'images/online-icon.png');
          }else {
            $(this).find('img').attr('src', 'images/offline-icon.png');
          }
        }       
      });
      $(".ajax-room-modal").each(function(){
        var room = $(this).attr('user-id'); 
        if(room !== undefined && room === who){
          if(status === 'on'){
            $(this).find('img').attr('src', 'images/online-icon.png');
          }else {
            $(this).find('img').attr('src', 'images/offline-icon.png');
          }
        }       
      });
    }

    $('#main').delegate('a.ajax-modal', 'click', function() {
      event.preventDefault();
      var user_id = $(this).attr('user-id');
      if(user_id !== undefined && user_id !== RTCApp.name) 
        RTCApp.commChannel.offer(user_id);
    });

    $('#main').delegate('a.ajax-room-modal', 'click', function() {
      event.preventDefault();
      RTCApp.room = $(this).attr('user-id');
      RTCApp.commChannel.roomOffer(RTCApp.room);
    });

    $.ajaxSetup({
    'beforeSend' : function(xhr) {
        xhr.overrideMimeType('text/html; charset=ISO-8859-1');
    },
    });

    window.onbeforeunload = function() {
      if(RTCApp.commChannel !== null)
        RTCApp.commChannel.sendPresence(RTCApp.name, 'off');
    }


    function loadFromJSON(file, class_name, class_div){
        $.getJSON(file, function(data) {
        var items = [];
        var i = 0;
        var groupIndex = 6;
       
        $.each(data, function() {
          var room = this.name;
          var image = this.img;
          var id = this.id;
             
          if(i % groupIndex === 0){
            if(i === 0)
              items.push('<div class="item active">');
            else
              items.push('<div class="item">');
            items.push('<ul class="thumbnails">');
          }
          
          items.push('<li class="span2"><div class="thumbnail"><img src="' + image +' " alt=""></a> <h4>' + room + '</h4><p><a href="#" class="btn btn-primary ' + class_name + ' " user-id="' + id + '" >Talk<img src="images/offline-icon.png" width="24" height="24" align="left" alt=""> </a></p></div></li>');

          if( (i % groupIndex) === (groupIndex - 1) ){
            items.push('</ul>');
            items.push('</div>');
          }
          i++;
        });
        
        if(items.lenght > 0 && items[items.lenght - 1].indexOf('div') < 0 ){
          items.push('</ul>');
          items.push('</div>');
        }
        
        $(items.join('')).appendTo(class_div);
      });

    }

    




  </script>
</html>
